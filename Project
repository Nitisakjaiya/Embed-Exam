#include <WiFi.h>
#include <MQTT.h>
#include <ESP32Servo.h>

// ===== WiFi =====
const char ssid[] = "NiTi";
const char pass[] = "444444444";

// ===== MQTT =====
const char mqtt_broker[] = "test.mosquitto.org";
const char mqtt_topic[]  = "group18/embed";s
const char mqtt_client_id[] = "arduino_group18_servo";
int MQTT_PORT = 1883;

// ===== Servo =====
#define SERVO_PIN 18
Servo servo;

// ===== ร้านอาหาร =====
String restaurants[] = {
  "Pizza", "KFC", "Shabu", "Somtum",
  "Ramen", "BBQ", "Burger", "Cafe"
};
const int shopCount = 8;

// ===== MQTT =====
WiFiClient net;
MQTTClient client;

// ================= MQTT CALLBACK =================
void messageReceived(String &topic, String &payload) {
  Serial.println("incoming: " + topic + " - " + payload);

  if (payload == "spin") {

    client.publish(mqtt_topic, "Spinning...");

    int choice = random(0, shopCount);
    int stepAngle = 180 / shopCount;
    int targetAngle = (choice * stepAngle) + (stepAngle / 2);

    // หมุนหลายรอบก่อน
    for (int round = 0; round < 3; round++) {
      for (int i = 0; i <= 180; i += 6) {
        servo.write(i);
        delay(10);
      }
    }

    // ชะลอแล้วหยุด
    for (int i = 180; i >= targetAngle; i -= 2) {
      servo.write(i);
      delay(30);
    }

    client.publish(mqtt_topic, "Result: " + restaurants[choice]);
    Serial.println("Selected: " + restaurants[choice]);
  }
}

// ================= CONNECT =================
void connect() {
  Serial.print("checking wifi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(1000);
  }

  Serial.print("\nconnecting MQTT...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print(".");
    delay(1000);
  }

  Serial.println("\nconnected!");
  client.subscribe(mqtt_topic);
}

// ================= SETUP =================
void setup() {
  Serial.begin(9600);

  servo.attach(SERVO_PIN);
  servo.write(0);

  WiFi.begin(ssid, pass);

  client.begin(mqtt_broker, MQTT_PORT, net);
  client.onMessage(messageReceived);

  randomSeed(analogRead(0));
  connect();
}

// ================= LOOP =================
void loop() {
  client.loop();
  delay(10);

  if (!client.connected()) {
    connect();
  }
}
