#include <WiFi.h>
#include <MQTT.h>
#include <ESP32Servo.h>

// ================= WiFi =================
const char ssid[] = "NiTi";
const char pass[] = "444444444";

// ================= MQTT =================
const char mqtt_broker[] = "test.mosquitto.org";
const char mqtt_topic[]  = "group18/embed";
const char mqtt_client_id[] = "arduino_group18_servo";
int MQTT_PORT = 1883;

// ================= PIN =================
#define SERVO_PIN 18
#define LED_PIN   22

// ================= OBJECT =================
WiFiClient net;
MQTTClient client;
Servo servo;

// ================= ร้านอาหาร =================
String restaurants[] = {
  "Pizza", "KFC", "Shabu", "Somtum",
  "Ramen", "BBQ", "Burger", "Cafe"
};
const int shopCount = 8;

// ================= MQTT CALLBACK =================
void messageReceived(String &topic, String &payload) {
  Serial.println("incoming: " + topic + " - " + payload);

  // ====== SPIN ======
  if (payload == "spin") {

    digitalWrite(LED_PIN, HIGH);          // LED ติด
    client.publish(mqtt_topic, "Spinning...");

    int choice = random(0, shopCount);
    int targetAngle = choice * (180 / shopCount);

    for (int i = 0; i <= targetAngle; i += 3) {
      servo.write(i);
      delay(20);
    }

    digitalWrite(LED_PIN, LOW);           // LED ดับ
    client.publish(mqtt_topic, "Result: " + restaurants[choice]);

    Serial.println("Selected: " + restaurants[choice]);
  }

  // ====== RESET ======
  else if (payload == "reset") {

    digitalWrite(LED_PIN, LOW);
    servo.write(0);                       // กลับตำแหน่งเริ่มต้น
    client.publish(mqtt_topic, "Reset complete");

    Serial.println("Servo reset to 0");
  }
}

// ================= CONNECT =================
void connect() {
  Serial.print("checking wifi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(1000);
  }

  Serial.print("\nconnecting MQTT...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print(".");
    delay(1000);
  }

  Serial.println("\nconnected!");
  client.subscribe(mqtt_topic);
}

// ================= SETUP =================
void setup() {
  Serial.begin(9600);

  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);

  servo.attach(SERVO_PIN);
  servo.write(0);                         // ตำแหน่งเริ่มต้น

  WiFi.begin(ssid, pass);

  client.begin(mqtt_broker, MQTT_PORT, net);
  client.onMessage(messageReceived);

  randomSeed(millis());
  connect();
}

// ================= LOOP =================
void loop() {
  client.loop();
  delay(10);

  if (!client.connected()) {
    connect();
  }
}
